# 6.8 Перезапуски автотестов в Pytest
[назад](../readme.md)

Содержание:
- [Основы перезапуска автотестов](#основы-перезапуска-автотестов)
- [Перезапуск автотестов в pytest](#перезапуск-автотестов-в-pytest)
  - [Добавление теста с перезапусками](#добавление-теста-с-перезапусками)
  - [Результат выполнения с перезапуском](#результат-выполнения-с-перезапуском)
  - [Использование @pytest.mark.flaky для классов](#использование-pytestmarkflaky-для-классов)
  - [Использование @pytest.mark.flaky с условиями](#использование-pytestmarkflaky-с-условиями)
- [Ссылки](#ссылки)


## Основы перезапуска автотестов
Проблемы с инфраструктурой или другие внешние факторы делают автотесты, особенно UI-тесты, нестабильными и склонными к падению из-за задержек на стороне инфраструктуры. Для повышения стабильности и преодоления временных сбоев существует такая практика, как перезапуски автотестов. Суть в том, что упавший тест запускается повторно, пока не пройдет успешно либо не исчерпает заданное количество попыток.

**Главные правила перезапуска автотестов**:  
- **Разумное количество попыток**. Перезапуск не должен превышать двух-трёх попыток. Перезапускать тест по 10 или 20 раз не имеет смысла — это только замедлит общее время выполнения автотестов. Если тест не прошёл после 2–3 попыток, значит, скорее всего, причина падения связана с багом или другой серьёзной проблемой, а не временным сбоем.
- **Перезапуск только нестабильных тестов**. Изначально перезапуски не нужны, если автотесты стабильны. Перед добавлением перезапуска к конкретному тесту необходимо проанализировать причины падений. Если причина в нестабильной инфраструктуре, тогда перезапуски могут помочь. Однако не стоит добавлять перезапуски ко всем тестам без разбора.
- **Предотвращение скрытия потенциальных проблем**. Иногда перезапуски могут маскировать реальную проблему. Например, когда в системе возникает гонка данных — ситуация, при которой данные не успевают синхронизироваться.

[вверх](#68-перезапуски-автотестов-в-pytest)


## Перезапуск автотестов в pytest
C помощью маркировки *@pytest.mark.flaky* можно добавлять перезапуски к автотестам
### Добавление теста с перезапусками
```python
import random
import pytest

@pytest.mark.flaky(reruns=3, reruns_delay=2)  # Перезапуски реализуются на уровне маркировки flaky
def test_reruns():
    assert random.choice([True, False])  # Случайный выбор для демонстрации нестабильного теста
```
В этом примере параметры маркировки @pytest.mark.flaky означают следующее:
- *reruns=3* — количество перезапусков. Если тест упадёт, он будет перезапущен до 3 раз.
- *reruns_delay=2* — задержка между перезапусками в секундах.

### Результат выполнения с перезапуском:
```sh
tests/pytest/test_reruns.py::test_reruns RERUN
tests/pytest/test_reruns.py::test_reruns PASSED
```
                  
- **RERUN** — тест test_reruns изначально завершился неудачей (например, из-за нестабильности системы или временного сбоя) и был автоматически перезапущен благодаря плагину rerunfailures.
- **PASSED** — после перезапуска тест успешно прошёл. Это демонстрирует, как перезапуск может помочь устранить временные или случайные сбои, не связанные с ошибками кода.

### Использование @pytest.mark.flaky для классов
```python
@pytest.mark.flaky(reruns=3, reruns_delay=2)  # Добавили тестовый класс
class TestReruns:
    def test_rerun_1(self):
        pass
```
### Использование @pytest.mark.flaky с условиями
В этом примере автотест *test_rerun_with_condition* будет перезапущен только в случае выполнения условия *PLATFORM == "Windows"*. Такое условие полезно для перезапуска автотестов только в определённой среде, например, на dev-окружении.
```python
PLATFORM = "Linux"
@pytest.mark.flaky(reruns=3, reruns_delay=2, condition=PLATFORM == "Windows")  # Перезапуск при выполнении условия
def test_rerun_with_condition():
    assert random.choice([True, False])
```
Если условие *PLATFORM == "Windows"* не выполняется, тест не будет перезапущен


[вверх](#68-перезапуски-автотестов-в-pytest)


## Ссылки:
- [pytest-rerunfailures](https://github.com/pytest-dev/pytest-rerunfailures)

[вверх](#68-перезапуски-автотестов-в-pytest)