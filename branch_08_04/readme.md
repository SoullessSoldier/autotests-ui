# 8.4 Добавление Playwright Trace Viewer в Allure отчет
[назад](../readme.md)

Содержание:
- [Что такое Playwright Trace Viewer](#что-такое-playwright-trace-viewer)
- [Изучаем отчет Playwright Trace Viewer](#изучаем-отчет-playwright-trace-viewer)
- [Учимся работать с Playwright Tracing из автотестов](#учимся-работать-с-playwright-tracing-из-автотестов)
- [Прикрепляем отчет Playwright Tracing к Allure отчету](#прикрепляем-отчет-playwright-tracing-к-allure-отчету)

## Что такое Playwright Trace Viewer?
Ссылки:
- [Официальная документация Playwright Trace Viewer](https://playwright.dev/python/docs/trace-viewer)
- [Web UI для загрузки результатов трейсинга](https://trace.playwright.dev/)

Playwright Trace Viewer — это мощный инструмент для отладки и анализа автотестов, который записывает и визуализирует выполнение тестов, показывая все действия, события и состояния на каждом этапе. Это особенно полезно для детального разбора проблем, которые возникают в тестах, а также для их эффективного устранения. Давайте разберем, что это такое, как работает и зачем его использовать.

### Что такое Playwright Trace Viewer?

**Playwright Trace Viewer** — это визуальный интерфейс, который позволяет просматривать трассировку тестов, выполненных с Playwright. Трассировка записывает всю информацию о работе теста: какие страницы открывались, какие действия выполнялись (например, клики, ввод текста, переходы по ссылкам), какие элементы на странице были доступны, какие запросы отправлялись в сеть, и даже все сделанные скриншоты.

Trace Viewer предоставляет пошаговую историю выполнения теста, вплоть до мельчайших деталей. Это позволяет:
- Отслеживать последовательность действий автотеста.
- Проверять результат выполнения каждой команды.
- Сравнивать ожидаемое поведение с фактическим.
- Видеть, как тест взаимодействовал с элементами страницы.
- Просматривать снимки экрана, сделанные на каждом шаге теста.

### Основные возможности Trace Viewer:
1. **Просмотр всех действий теста:** каждый шаг теста представлен в Trace Viewer как отдельное действие, которое можно изучить детально — какой элемент был нажат, с какими данными взаимодействовал тест и как изменилась страница.
2. **История изменения состояния страницы:** Trace Viewer позволяет видеть, как изменялась страница во время теста, что особенно полезно при отладке проблем, связанных с динамическими элементами или AJAX-запросами.
3. **Запись сетевых запросов:** в Trace Viewer можно увидеть все запросы, которые отправлялись в сеть в процессе выполнения теста, их заголовки и ответы от сервера. Это помогает выявлять проблемы с загрузкой данных или неправильными ответами сервера.
4. **Скриншоты на каждом шаге:** можно видеть, как выглядел интерфейс приложения в момент выполнения каждого шага, что упрощает понимание контекста выполнения теста.
5. **Возможность просмотра файлов и консольных логов:** Trace Viewer отображает файлы, с которыми взаимодействовал тест (например, если были загрузки или загрузки файлов), а также выводы в консоль, что полезно для отладки сложных сценариев.
6. **События ввода:** можно увидеть все действия пользователя (клики, прокрутки, ввод текста), что позволяет точно понять, как автотест "работал" с приложением.

### Зачем нужен Playwright Trace Viewer?
Trace Viewer — это отличный инструмент для:
- **Поиска причин падения тестов**. Часто автотесты падают на сложных сценариях, где элементы страницы динамически изменяются, возникают ошибки JavaScript или запросы в сеть задерживаются. С Trace Viewer можно пошагово изучить, на каком этапе что-то пошло не так.
- **Анализа асинхронных операций**. Множество веб-приложений используют асинхронные операции, такие как AJAX-запросы, загрузка данных из API и т.д. С помощью Trace Viewer можно анализировать время загрузки и реакции приложения на такие запросы.
- **Оптимизации тестов**. Можно увидеть, на каких шагах тесты занимают слишком много времени, и подумать о том, как сделать их более эффективными.
- **Воспроизведения проблем**. Иногда ошибка не всегда воспроизводится при обычном запуске теста, но с помощью трассировки можно получить полную картину и воспроизвести проблему вручную.

[вверх](#84-добавление-playwright-trace-viewer-в-allure-отчет)


## Изучаем отчет Playwright Trace Viewer

Давайте посмотрим из чего состоит отчет Playwright Trace Viewer и какую полезную информацию он может нам предоставить

### Что такое снапшоты?
Снапшоты веб-страниц — это сохранённые состояния веб-страницы в конкретный момент времени во время выполнения автотеста. Эти снапшоты фиксируют визуальные и DOM (Document Object Model) состояния страницы, что даёт возможность анализировать, как выглядела и функционировала страница на разных этапах теста.

В Playwright снапшоты — это часть трассировки, которая позволяет "перематывать" тест и видеть страницу в моменты, когда происходили ключевые действия, такие как клики, навигация или заполнение форм.

#### Что включают снапшоты?
1. **DOM-состояния**: Снимки структуры HTML-документа, включая текущее состояние всех элементов на странице, их свойства, атрибуты и отношения друг с другом. Это позволяет видеть, каким был DOM в момент теста, даже если он изменялся динамически через JavaScript.
2. **CSS и стили**: Визуальное отображение страницы фиксируется с учётом всех применённых стилей, включая динамические стили и изменения, происходящие на странице, например при наведении курсора или кликах.
3. **Скриншоты**: Как часть снапшота, Playwright может сохранять скриншоты, чтобы показать, как именно выглядела страница или её часть в определённый момент времени.
4. **Интерактивные элементы**: Снапшоты фиксируют не только визуальное отображение, но и состояние элементов, с которыми происходило взаимодействие: были ли они активны, заблокированы, или какие значения содержали.

### Просмотр конкретного действия
В отчете Playwright Trace Viewer есть очень удобная функция: вы можете нажать на любое действие автотеста в левой панели, и в правой панели сразу же покажется снапшот страницы в этот момент времени. Это позволяет визуально оценить, как выглядело состояние веб-страницы при выполнении конкретного шага теста.
Этот инструмент упрощает анализ, так как вы можете пройтись по каждому действию автотеста и понять, на каком этапе произошла ошибка, без необходимости вручную перебирать логи или воспроизводить тесты.

### Просмотр кода действия
В дополнение к снапшотам, Playwright Trace Viewer также отображает код, который выполнял конкретное действие. Это позволяет быстро понять, какой метод или команда привели к выполнению шага. Таким образом, вы сразу видите:
- Вызванный код,
- Состояние страницы,
- Выполненные шаги, что значительно ускоряет поиск и устранение проблем.

Больше не нужно тратить время на поиски в огромных логах – вся информация для анализа уже отображена в удобном интерфейсе.

### Как сохранить отчет Playwright Trace Viewer?
Для того чтобы сохранить данные trace для каждого теста, можно воспользоваться методами *context.tracing.start* и *context.tracing.stop*.

Вот пример кода:
```python
# Начало записи trace
context.tracing.start(
    screenshots=True,  # Записываем скриншоты каждого шага
    snapshots=True,    # Записываем состояние страницы (DOM, CSS и др.)
    sources=True       # Включаем исходные коды (сценарии тестов, JS кода и т.д.)
)

# Выполняем тесты

# Остановка записи и сохранение в файл trace.zip
context.tracing.stop(path="trace.zip")
```
                  
После записи теста файл trace.zip можно загрузить в Playwright Trace Viewer, запустив его через команду:
```sh
playwright show-trace trace.zip
```

### Как открыть отчет в браузере?
Если у вас или ваших коллег не установлен Python и Playwright, вы всё равно можете открыть отчет, используя веб-интерфейс https://trace.playwright.dev/. Это особенно полезно для ручных тестировщиков или разработчиков, у которых нет настроенного окружения для Playwright. Чтобы поделиться отчетом:
- Сгенерируйте файл trace.zip.
- Отправьте его коллегам.
- Коллеги смогут загрузить этот файл в веб-интерфейсе Playwright Trace Viewer по ссылке: [trace.playwright.dev](https://trace.playwright.dev/).

[вверх](#84-добавление-playwright-trace-viewer-в-allure-отчет)


## Учимся работать с Playwright Tracing из автотестов

Для того чтобы собрать отчет Playwright Trace Viewer из автотестов, нам нужно модифицировать фикстуры *chromium_page* и *chromium_page_with_state*, которые находятся в файле *./fixtures/browsers.py*

Модификация фикстуры chromium_page с включением трейсинга:
```python
import pytest
from _pytest.fixtures import SubRequest  # Импортируем класс SubRequest для аннотации
from playwright.sync_api import Playwright, Page

from pages.authentication.registration_page import RegistrationPage


@pytest.fixture
def chromium_page(request: SubRequest, playwright: Playwright) -> Page:  # Добавили аргумент request
    browser = playwright.chromium.launch(headless=False)
    context = browser.new_context()  # Создаем контекст для новой сессии браузера
    context.tracing.start(screenshots=True, snapshots=True, sources=True)  # Включаем трейсинг

    yield context.new_page()  # Открываем новую страницу в контексте
     
    # В данном случае request.node.name содержит название текущего автотеста
    context.tracing.stop(path=f'./tracing/{request.node.name}.zip')  # Сохраняем трейсинг в файл
    browser.close()  # Закрываем браузер
```

### Что изменилось и зачем:
1. Добавлен параметр request в фикстуру:
    - **Зачем это нужно**: аргумент *request* используется для получения информации о текущем автотесте (например, его имя). Это нужно для того, чтобы уникально называть файл с трейсингом для каждого теста.
    - **Тип**: это объект класса *SubRequest*, который предоставляет доступ к информации о тесте, включая его имя через *request.node.name*.
2. Создание нового контекста браузера:
    - **Раньше**: Фикстура просто открывала новую страницу с помощью *browser.new_page()*.
    - **Теперь**: Перед созданием страницы фикстура создает новый контекст с помощью *browser.new_context()*.
    - **Что такое контекст**: Контекст позволяет запускать изолированные сессии, что полезно для параллельного тестирования. Внутри контекста можно настроить cookies, хранилища данных, и собирать трейсинг.
3. Включение трейсинга:
    - Сразу после создания контекста начинается запись трейсинга с помощью *context.tracing.start()*. В параметры передаются:
        - *screenshots=True*: записываются скриншоты каждого шага.
        - *snapshots=True*: сохраняются снапшоты DOM и стилей страницы.
        - *sources=True*: записываются исходные коды (например, сценарии тестов или JavaScript).
    - **Зачем это нужно**: Трейсинг позволяет собрать полную информацию о каждом шаге теста, включая скриншоты, изменения на странице и выполненные команды. Это очень полезно для отладки, так как вы сможете увидеть точную последовательность действий и их результат.
4. **Сохранение трейсинга по завершении теста**:
    - Когда тест завершается, запись трейсинга останавливается с помощью *context.tracing.stop()*. Файл с данными сохраняется в директорию *./tracing/* с именем, совпадающим с названием автотеста.
    - *path=f'./tracing/{request.node.name}.zip'*: сохраняет файл с трейсингом под именем теста. Это позволяет для каждого теста иметь отдельный файл с полным набором данных, чтобы упростить анализ ошибок.
5. Закрытие браузера:
    - Как и в оригинальной версии, браузер закрывается после завершения теста с помощью *browser.close()*.


### Ключевые моменты:
    - **Контекст**: Использование контекста важно, так как это изолированная сессия браузера. Это позволяет записывать все действия в рамках одного теста, без влияния других тестов.
    - **Трейсинг**: Трейсинг собирает полную информацию о каждом действии на странице. Это полезно для дебага и анализа выполнения тестов. Вы сможете видеть не только ошибки, но и пошаговое состояние страницы.
    - **Использование имени теста**: Фикстура сохраняет файл с трейсингом с именем теста, что упрощает организацию отчетов. Каждый тест получает свой собственный файл с результатами.

### Генерация отчета Playwright Trace Viewer
Теперь давайте запустим автотесты и сгенерируем отчеты для Playwright Trace Viewer:
```sh
python -m pytest -m "regression"
```
                  
После завершения тестов в корне проекта появится папка tracing с zip-файлами отчетов:
```
.
└── tracing/
    ├── test_create_course.zip
    ├── test_dashboard_displaying.zip
    ├── test_edit_course.zip
    ├── test_empty_courses_list.zip
    ├── test_navigate_from_authorization_to_registration.zip
    └── ...
```
                  
Чтобы открыть отчет, например, test_create_course.zip, выполните команду:
```sh
playwright show-trace ./tracing/test_create_course.zip
```

[вверх](#84-добавление-playwright-trace-viewer-в-allure-отчет)


## Прикрепляем отчет Playwright Tracing к Allure отчету

### Как прикрепить файл к Allure отчету?
Чтобы прикрепить файл с трейсингом (или любой другой файл) к Allure отчету, мы можем воспользоваться функцией *allure.attach.file()* из библиотеки **Allure-Pytest**. Эта функция позволяет добавлять различные файлы, такие как текстовые данные, изображения, HTML или другие форматы, к шагам или результатам автотестов. В нашем случае это будет отчет **Playwright Trace Viewer** в формате *.zip*.

### Пример модификации фикстуры для прикрепления файла
Теперь давайте модифицируем фикстуру chromium_page, чтобы после сохранения файла с трейсингом он автоматически прикреплялся к Allure отчету:
```python
import allure  # Импортируем библиотеку для работы с Allure
import pytest
from _pytest.fixtures import SubRequest
from playwright.sync_api import Playwright, Page

@pytest.fixture
def chromium_page(request: SubRequest, playwright: Playwright) -> Page:
    browser = playwright.chromium.launch(headless=False)
    context = browser.new_context()
    context.tracing.start(screenshots=True, snapshots=True, sources=True)

    yield context.new_page()

    context.tracing.stop(path=f'./tracing/{request.node.name}.zip')
    browser.close()

    # Прикрепляем файл с трейсингом к Allure отчету
    allure.attach.file(f'./tracing/{request.node.name}.zip', name='trace', extension='zip')

```
Что произошло в этой фикстуре:
1. Импортируем библиотеку Allure:
    - Мы добавляем *import allure* для работы с Allure и возможности прикрепления файлов.
2. Останавливаем трейсинг и сохраняем файл:
    - После завершения теста, как и ранее, мы останавливаем трейсинг и сохраняем файл в папку *./tracing/*.
3. Прикрепляем отчет к Allure:
    - Используем функцию allure.attach.file() для добавления файла с трейсингом к Allure отчету:
        - *f'./tracing/{request.node.name}.zip'*: путь к файлу трейсинга, который мы сохранили.
        - *name='trace'*: это имя, под которым файл будет отображаться в Allure отчете. Мы используем название теста, чтобы файлы можно было легко идентифицировать.
        - *extension='zip'*: указываем расширение файла, в данном случае это *zip*, так как Playwright Trace Viewer создает zip-архив.

### Запуск автотестов
Теперь можно запустить автотесты и посмотреть Allure отчет. Для этого удалите папку allure-results, чтобы получить свежие результаты:
```sh
python -m pytest -m "regression" --alluredir=./allure-results
```
                  
Запустите Allure отчет:
```sh
allure serve ./allure-results
```
                  
В Allure отчете в блоке **Tear down** для каждого теста, где был включен трейсинг, будет отображаться файл с отчетом Playwright Trace Viewer. Этот файл можно скачать прямо из Allure отчета, что значительно упрощает процесс отладки.

### Как это помогает?
- **Детальный анализ упавших тестов**: Если какой-то автотест не прошел, можно прямо из Allure отчета скачать отчет Playwright Trace Viewer и посмотреть, что происходило во время выполнения теста. Это позволяет избежать необходимости повторного запуска тестов и тратить время на ручной дебаг.
- **Анализ производительности**: Если вы заметили, что тест выполнялся слишком долго, отчет Playwright Trace Viewer позволит вам определить, на каком шаге теста происходили задержки.
- **Удобство для разработчиков**: Отчет трейсинга можно отправить разработчику, чтобы он мог детально воспроизвести проблему на своей стороне без необходимости установки Playwright.

Таким образом, интеграция трейсинга с Allure отчетами делает процесс отладки и анализа тестов значительно проще и быстрее.

[вверх](#84-добавление-playwright-trace-viewer-в-allure-отчет)
