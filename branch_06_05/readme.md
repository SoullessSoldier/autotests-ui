# 6.5 Фикстуры в pytest
[назад](../readme.md)

Содержание:
- [Определение фикстуры](#определение-фикстуры)
- [Хранение фикстур в conftest.py](#хранение-фикстур-в-conftestpy)
- [Практикуемся в использовании pytest.mark.usefixtures](#практикуемся-в-использовании-pytestmarkusefixtures)
- [Работа с плагином pytest-playwright](#работа-с-плагином-pytest-playwright)
- [Практика работы с pytest фикстурами](#практика-работы-с-pytest-фикстурами)


Файлы ./tests/lesson/*.py - файлы практики

## Определение фикстуры
- Сценарии использования:
  - Подготовка данных
  - Инициализация ресурсов
  - Фоновые действия
- Уровни фикстур (function, class, module, session)
- Разбор Setup и Teardown в контексте фикстур в pytest
- Фикстуры с зависимостями

[вверх](#65-фикстуры-в-pytest)


## Хранение фикстур в conftest.py
Файл conftest.py в pytest — это место, где можно хранить фикстуры, которые будут доступны во всем проекте или в отдельных модулях без необходимости их явного импорта. Это облегчает структуру тестов и позволяет разделять фикстуры по разным уровням.

Пример организации файлов:
```
.
└── tests/
    ├── conftest.py # Фикстуры будут доступны во всех автотестах
    ├── registration/
    │   ├── conftest.py # Фикстуры будут доступны ТОЛЬКО в рамках модуля registration
    │   ├── test_registration.py
    │   └── test_admin_registration.py
    └── authorization/
        ├── conftest.py # Фикстуры будут доступны ТОЛЬКО в рамках модуля authorization
        ├── test_authorization.py
        └── test_admin_authorization.py
```
                  
Глобальный conftest.py: фикстуры в tests/conftest.py будут доступны во всех тестах.
Локальные conftest.py: фикстуры в registration/conftest.py будут доступны только в registration

[вверх](#65-фикстуры-в-pytest)


## Практикуемся в использовании pytest.mark.usefixtures
Использование декоратора pytest.mark.usefixtures  
Использование pytest.mark.usefixtures особенно полезно для выполнения действий, которые необходимы перед тестами, но не возвращают результат, например, отправка аналитики или настройка окружения.

[вверх](#65-фикстуры-в-pytest)


## Работа с плагином pytest-playwright

**Что такое pytest-playwright?**
*pytest-playwright* — это плагин для фреймворка тестирования pytest, который упрощает использование библиотеки Playwright. Он интегрирует возможности Playwright напрямую в тесты pytest, что позволяет писать веб-тесты с меньшими усилиями и улучшает читаемость и поддержку тестов.

**Что предоставляет pytest-playwright?**  
1) Упрощённая настройка браузера через фикстуры:

  - pytest-playwright предоставляет готовые фикстуры для работы с Playwright, которые автоматически создают браузерные сессии и предоставляют доступ к основным объектам Playwright: браузеру, контекстам, страницам.
  - Например, вы можете использовать такие фикстуры, как page, которая предоставляет вам объект страницы Playwright, готовый к использованию в тесте.

Пример использования фикстуры page:
```
def test_example(page):
    page.goto("https://example.com")
    assert page.title() == "Example Domain"
```
                  
2) Поддержка различных браузеров:

- Плагин позволяет легко переключаться между различными браузерами (Chromium, Firefox, WebKit) при выполнении тестов, без необходимости вручную изменять код тестов.
- Можно запустить тесты в нескольких браузерах одновременно с помощью специальных опций pytest, например, с ключом *--browser*:
```
pytest --browser chromium 
pytest --browser firefox
```
                  
3) Настройка режима headless:

- *pytest-playwright* поддерживает запуск тестов в режиме без графического интерфейса (headless) или с интерфейсом (headful).
- Вы можете использовать флаг командной строки, чтобы выбрать режим работы браузера:
```
pytest --headless
pytest --headful
```
Это удобно для автоматизации CI/CD процессов.

4) Фикстуры для управления сессиями браузера:

Плагин предоставляет фикстуры для управления различными уровнями сессий браузера, такими как:
- Браузер (например, *browser*)
- Контекст браузера (например, *context* — позволяет изолировать сессии между тестами)
- Страница (например, *page* — это объект страницы, на которой будут выполняться действия)

5) Автоматический сбор логов и трейсинга:

Playwright позволяет собирать данные о выполнении тестов, такие как скриншоты, видео, трассировки. Эти данные могут быть автоматически сохранены при помощи pytest-playwright для дальнейшего анализа ошибок или анализа прохождения тестов.

6) Работа с пользовательскими агентами, cookie и storage state:

pytest-playwright также поддерживает работу с кастомными настройками браузера, такими как пользовательские агенты, сохранение и загрузка состояния сессий (cookie и storage state), что может быть полезно для тестов авторизации и многократного использования сессий между тестами.

**Установка pytest-playwright**
Выполним команду в корне проекта autotests-ui:
```
pip install pytest-playwright
```
                  
После установки библиотеки pytest-playwright нам автоматически становится доступен весь функционал в виде фикстур и настроек.

[вверх](#65-фикстуры-в-pytest)


## Практика работы с pytest фикстурами
В данном задании необходимо отработать навык работы с фикстурами в pytest. Вам нужно выполнить следующие шаги:

1. **Создать фикстуру** *initialize_browser_state*:
- Эта фикстура должна регистрировать нового пользователя и сохранять состояние браузера для последующего использования.
- Код сохранения состояния браузера был ранее реализован в тесте *test_empty_courses_list*, но теперь его нужно вынести в фикстуру.
- Фикстура должна выполняться **один раз** за всю сессию тестирования.
- После выполнения фикстуры должен появиться файл *browser-state.json*.
- Фикстура **не должна** использовать *autouse*.
- Фикстура не должна возвращать никаких значений.

2. **Создать фикстуру** *chromium_page_with_state*:
- Эта фикстура должна открывать новую страницу браузера, используя сохраненное состояние из файла *browser-state.json*.
- Фикстура должна иметь область видимости *function* и **использоваться явно в каждом автотесте, которому необходим доступ к авторизованной сессии**.
- Она будет использоваться для загрузки браузера с сохраненными данными (например, для авторизации).
- Данная фикстура должна использовать ранее созданную фикстуру *initialize_browser_state*.
```python
@pytest.fixture
def chromium_page_with_state(initialize_browser_state, playwright: Playwright) -> Page:
    # Реализация логики работы фикстуры
```
                  
3. **Организовать фикстуры в файл** *conftest.py*:
```text
.
└── tests/
    └── conftest.py
```
                  
Все созданные фикстуры необходимо объявить в файле conftest.py в папке tests/.

4. **Изменить автотест** *test_empty_courses_list*:
- Модифицируйте автотест так, чтобы он использовал созданную фикстуру *chromium_page_with_state*.
- Фикстура *chromium_page_with_state* должна быть использована напрямую в аргументах теста, **без использования** *@pytest.mark.usefixtures*.
- Фикстуру *initialize_browser_state* никак внутри теста *test_empty_courses_list* использовать не нужно, данная фикстура должна быть использована **только** на уровне фикстуры *chromium_page_with_state*.
- Ваша задача — упростить код, вынеся логику работы с браузером в фикстуры.

**Критерии выполнения задания**
- **Структура проекта**
  - Все фикстуры вынесены в файл *tests/conftest.py*.
  - Тест *test_empty_courses_list* находится в файле *tests/test_courses.py*.
- **Фикстура** *initialize_browser_state*
  - Фикстура регистрирует нового пользователя через страницу регистрации.
  - После регистрации сохраняет состояние браузера в файл *browser-state.json*.
  - Имеет область видимости *session*.
  - Не использует *autouse*.
  - Не возвращает никаких значений.
  - После выполнения в проекте должен появиться файл browser-state.json.
- **Фикстура** *chromium_page_with_state*
  - Использует сохранённое состояние из файла *browser-state.json*.
  - Имеет область видимости *function*.
  - Используется **явно в аргументах теста** (без *@pytest.mark.usefixtures*).
  - Зависит от фикстуры *initialize_browser_state*.
  - Возвращает страницу (**Page**) с уже авторизованной сессией.
- **Тест** *test_empty_courses_list*
  - Использует фикстуру *chromium_page_with_state* в аргументах.
  - Не использует напрямую фикстуру *initialize_browser_state*.
  - Проверяет элементы на странице **Courses**:
    - Заголовок "Courses" – наличие и текст.
    - Иконка пустого списка – наличие/видимость.
    - Заголовок пустого блока "There is no results" – наличие и текст.
    - Описание пустого блока "Results from the load test pipeline will be displayed her" – наличие и текст.
- **Запуск и результат**
  - Тест запускается командой *python -m pytest -s -v* и успешно проходит.
  - Исполнение завершается без ошибок.
- **Качество реализации**
  - Код аккуратно структурирован, дублирование логики вынесено в фикстуры.
  - Используются стабильные селекторы (*data-test-id*).
  - Соблюдены правила PEP8.


### Результат
```sh
vscode@d2c9810e91cd:~/workspace$ flake8 ./tests/conftest.py ./tests/test_courses.py 
vscode@d2c9810e91cd:~/workspace$ pytest -s -v -m 'courses'
======================== test session starts ===================================
platform linux -- Python 3.12.7, pytest-8.4.1, pluggy-1.6.0 -- /usr/local/bin/python3.12
cachedir: .pytest_cache
rootdir: /home/vscode/workspace
configfile: pytest.ini
plugins: playwright-0.7.0, base-url-2.1.0, allure-pytest-2.15.0
collected 16 items / 15 deselected / 1 selected

tests/test_courses.py::test_empty_courses_list PASSED

======================== 1 passed, 15 deselected in 15.20s =====================
```

[вверх](#65-фикстуры-в-pytest)


Ссылки:
- [Официальная документация Pytest по работе с фикстурами](https://docs.pytest.org/en/6.2.x/fixture.html)
- [Официальная документация Pytest по работе с conftest.py файлами](https://docs.pytest.org/en/6.2.x/fixture.html#conftest-py-sharing-fixtures-across-multiple-files)

[вверх](#65-фикстуры-в-pytest)