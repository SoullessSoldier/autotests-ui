# 9.1 Настройки автотестов с Pydantic
[назад](../readme.md)


Содержание:
- [Настройки проекта](#настройки-проекта)
- [Знакомство с pydantic](#знакомство-с-pydantic)
- [Знакомство с pydantic-settings](#знакомство-с-pydantic-settings)
- [Создаем *.env* файл с настройками](#создаем-env-файл-с-настройками)
- [Улучшаем работу с настройками](#улучшаем-работу-с-настройками)
- [Применение настроек в автотестах](#применение-настроек-в-автотестах)
- [Практика работы с настройками](#практика-работы-с-настройками)

## Настройки проекта

Ссылки:
- [Официальная документация pydantic](https://docs.pydantic.dev/latest/)
- [Официальная документация pydantic-settings](https://docs.pydantic.dev/latest/concepts/pydantic_settings/)

### Зачем нужны настройки в проекте?
Настройки проекта — это централизованное хранилище всех важных параметров, используемых в проекте. Они позволяют упрощать управление конфигурацией, особенно когда ваш проект становится более сложным. Когда мы говорим о настройках, мы имеем в виду такие параметры, как ссылки на сервисы, параметры окружения, данные для авторизации, настройки тестовых окружений и т.д.

Основное преимущество наличия настроек — это возможность изменять параметры проекта в одном месте, не касаясь всего кода. Например, если нужно поменять ссылку на тестируемое приложение, вам не придётся искать и менять её по всему проекту. Достаточно изменить её в одном месте — в файле настроек. Это значительно упрощает поддержку проекта и делает его более гибким.

### Какие данные обычно выносятся в настройки?
В зависимости от проекта, в настройки могут быть вынесены различные параметры. Примеры типичных данных, которые выносят в настройки:
- **URL тестируемого приложения**. Например, для нашего курса это может быть ссылка на сайт: *https://nikita-filonov.github.io/qa-automation-engineer-ui-course/*. В случае смены окружения или сервера, вам будет достаточно поменять ссылку только в одном месте.
- **Список браузеров для запуска автотестов**. В настройках можно указать, какие браузеры использовать для тестирования: Chrome, Firefox, Safari и т.д.
- **Пути к директориям для сохранения артефактов тестов**. Например, куда сохранять видео или файлы трассировки (trace) после выполнения тестов.
- **Данные тестового пользователя**. Часто для тестирования используется один и тот же тестовый аккаунт. В настройки выносятся данные для авторизации, такие как логин и пароль, чтобы они были доступны везде, где это необходимо.
- **Файл состояния браузера**. Этот файл может содержать данные, например, о сохраненных сессиях или куки, чтобы тесты могли запускаться с определённым контекстом.

### Почему стоит использовать Pydantic и pydantic-settings?
Использование библиотеки **Pydantic** позволяет удобно и безопасно управлять настройками. Она предоставляет инструмент для валидации данных, что гарантирует корректность настроек. Например, если по ошибке ввести неправильный тип данных в конфигурацию (например, число вместо строки), Pydantic выдаст ошибку на этапе загрузки приложения, а не в процессе выполнения.

Библиотека **pydantic-settings** расширяет возможности Pydantic и позволяет загружать настройки из различных источников — это могут быть файлы *.env*, переменные окружения, JSON или YAML файлы. Это делает настройку и конфигурацию проекта гибкой и удобной, особенно для работы с разными окружениями (например, разработка, тестирование и продакшн).

Таким образом, настройки проекта позволяют сделать ваш код более поддерживаемым, гибким и лёгким в управлении.

[вверх](#91-настройки-автотестов-с-pydantic)


## Знакомство с pydantic

Ссылки:
- [Официальная документация pydantic](https://docs.pydantic.dev/latest/)

### Зачем использовать Pydantic?
- **Валидация данных**: Автоматически проверяет данные, соответствуют ли они типам, которые вы задали.
- **Упрощение работы с данными**: Позволяет преобразовывать данные между различными форматами (например, JSON, dict, SQLAlchemy объекты и т.д.).
- **Ясность и безопасность**: Код становится более безопасным и понятным, так как вся логика проверки встроена в модели.

### Установка Pydantic
Прежде чем начать работу с Pydantic, необходимо установить библиотеку.
```sh
pip install pydantic
```

Для проверки функционала создадим файлы в корне проекта:
```text
.
├── pydantic_user.py
└── pydantic_product.py
```

1. Создание файла pydantic_user.py
2. Создание первой Pydantic модели
3. Создание объекта на основе модели 
4. Валидация данных
5. Поля с дополнительными настройками
6. Работа с вложенными моделями

### Итог
В этом шаге мы познакомились с базовыми возможностями Pydantic. Мы научились:
- Создавать модели данных.
- Работать с полями и их типами.
- Использовать валидацию и вложенные модели.
- Pydantic упрощает работу с данными и их валидацией, что делает его отличным инструментом для более сложных проектов. В следующем шаге мы будем использовать - pydantic-settings для управления настройками нашего проекта на основе Pydantic.

[вверх](#91-настройки-автотестов-с-pydantic)


## Знакомство с pydantic-settings

Ссылки:
- [Официальная документация pydantic-settings](https://docs.pydantic.dev/latest/concepts/pydantic_settings/)

### Что такое *pydantic-settings*?
*pydantic-settings* — это расширение библиотеки Pydantic, созданное специально для управления настройками проектов. Как и Pydantic, она поддерживает валидацию данных и использует аналогичный синтаксис, что делает её интуитивно понятной и мощной для работы с настройками.

Можно сказать, что Pydantic и *pydantic-settings* — это две связанные библиотеки, но *pydantic-settings* имеет дополнительные возможности, такие как работа с переменными окружения и *.env* файлами.

### Почему использовать именно pydantic-settings?
Есть несколько ключевых причин:
- **Встроенная валидация типов данных**. Как мы видели ранее, Pydantic умеет проверять типы данных. Это же работает и в pydantic-settings, что обеспечивает надёжность данных, например, при работе с настройками.
- **Встроенные типы данных**. *pydantic-settings* позволяет использовать встроенные типы Pydantic, такие как *HttpUrl*, *EmailStr*, *FilePath*, *DirectoryPath*, и [другие](https://docs.pydantic.dev/latest/api/networks/). Это даёт возможность валидации специфичных типов данных, например URL или файлов.
- **Работа с переменными окружения и *.env* файлами**. *pydantic-settings* автоматически подхватывает переменные окружения и значения из .env файлов. Это упрощает настройку окружений, например, для разработки, тестирования и продакшена.
- **Популярность и поддержка сообщества**. Pydantic и *pydantic-settings* — широко используемые библиотеки с отличной документацией и активным сообществом разработчиков. У Pydantic более 21K звезд на GitHub на момент написания этого урока

### Установка pydantic-settings
Для начала, установим библиотеку вместе с дополнительными валидаторами:
```sh
pip install pydantic-settings 'pydantic[email]'
```

### Создание файла config.py
Теперь создадим файл config.py в корне нашего проекта:
```text
.
└── config.py
```

### Расширяем модель Settings

### Валидация данных в модели

[вверх](#91-настройки-автотестов-с-pydantic)


## Создаем *.env* файл с настройками

Перед тем как начать работу с библиотекой *pydantic-settings*, важно понять, что такое переменные окружения и *.env* файл, так как они играют ключевую роль в настройке проектов.

### Что такое переменные окружения?

Переменные окружения — это особые переменные, которые хранят настройки или конфигурационные данные и доступны в операционной системе для различных программ и скриптов. В контексте Python и автотестов, переменные окружения позволяют гибко управлять настройками приложения без необходимости вносить изменения в код.

#### Зачем нужны переменные окружения?
- **Универсальность**. Настройки, хранимые в переменных окружения, не зависят от самого приложения. Это позволяет менять настройки в зависимости от окружения (например, продакшн или тестовое окружение).
- **Безопасность**. В переменных окружения удобно хранить конфиденциальную информацию, например, ключи API или данные учетных записей, без их записи в код.
- **Удобство развертывания**. При использовании CI/CD-процессов можно легко подменять настройки для разных сред, что упрощает автоматизацию.

#### Как установить переменные окружения?
Способ установки переменных окружения зависит от операционной системы, но процесс везде достаточно схожий

#### Что такое *.env* файл?
***.env* файл** — это текстовый файл, содержащий переменные окружения и их значения. Этот файл обычно хранится в корне проекта и используется для упрощенного управления настройками, особенно в процессе разработки.

#### Зачем нужен .env файл?
1. **Простота**. Вместо того чтобы устанавливать переменные вручную в каждой среде, вы можете использовать .env файл для централизованного хранения всех нужных настроек.
2. **Удобство разработки**. Легко переключаться между разными конфигурациями для разработки, тестирования и продакшена.
3. **Совместимость**. Многие библиотеки, такие как pydantic-settings, поддерживают автоматическую загрузку переменных из .env файлов, что делает работу с настройками ещё проще.

#### Как работать с .env файлом в pydantic-settings?
1. Подготовка модели Settings
2. Создаем файл *.env* в корне проекта
3. Добавляем переменные окружения в .env файл
4. Проверяем работу настроек

[вверх](#91-настройки-автотестов-с-pydantic)


## Улучшаем работу с настройками

1. Добавляем метод initialize в модель Settings
2. Проверка работы
3. Удаляем переменные окружения VIDEOS_DIR, TRACING_DIR, BROWSER_STATE_FILE\

[вверх](#91-настройки-автотестов-с-pydantic)


## Применение настроек в автотестах

1. Создание глобальной переменной *settings*
    Для использования настроек их нужно инициализировать. Сделаем это в файле *config.py*. В конце файла добавим глобальную переменную *settings* для инициализации настроек
2. Применение settings в *initialize_playwright_page*
    Изменения включают:
        - Импортируем настройки *from config import settings*
        - Вместо *headless=False* теперь используем *headless=settings.headless*.
        - Поле *record_video_dir='./videos'* заменено на *settings.videos_dir*.
        - Для построения пути к файлам использован *settings.tracing_dir.joinpath(f'{test_name}.zip')*.
3. Применение settings в *chromium_page_with_state*
4. Применение settings в *initialize_browser_state*
5. Тестирование

### Промежуточный итог использования настроек
Как вы можете видеть, теперь мы используем настройки и избегаем хардкода данных пользователя или дублирования названий файлов и папок. Например, если тестовый пользователь изменится, вам будет достаточно изменить его данные в одном месте — в *.env* файле. Все изменения автоматически будут применены по всему проекту. Это значительно упрощает поддержку кода, делает его более гибким и позволяет адаптироваться к различным окружениям без необходимости менять код вручную.

[вверх](#91-настройки-автотестов-с-pydantic)


## Практика работы с настройками

[ссылка на описание домашней работы](./homework.md)

[вверх](#91-настройки-автотестов-с-pydantic)
