# 10.2 CI/CD системы
[назад](../readme.md)


Содержание:
- [GitLab CI](#gitlab-ci)
- [GitHub Actions](#github-actions)
- [Jenkins](#jenkins)
- [CircleCI](#circleci)
- [TeamCity](#teamcity)

## GitLab CI

[GitLab CI](https://docs.gitlab.com/ee/ci/) (Continuous Integration) — это инструмент для автоматизации процессов разработки, тестирования и деплоя, встроенный в платформу GitLab. Он позволяет разработчикам настраивать автоматизированные процессы, которые запускаются при каждом изменении в коде. В контексте автоматизации тестирования GitLab CI помогает автоматически запускать автотесты, получать результаты и делиться ими с командой.

### Как работает GitLab CI
1. Файл .gitlab-ci.yml — основной конфигурационный файл для GitLab CI. Этот файл хранится в корне репозитория и содержит все инструкции по запуску CI-процессов. Файл описывает, какие действия необходимо выполнить при разных событиях, таких как создание коммита или Pull Request.

2. Stages (Этапы) — этапы, на которые делится CI-процесс. Этапы выполняются последовательно, например, сначала сборка (build), затем тестирование (test), а затем деплой (deploy).

3. Jobs (Задачи) — конкретные задания в каждом этапе, такие как запуск тестов или сборка артефактов. Задачи в одном этапе могут выполняться параллельно, если позволяет инфраструктура.

4. Runners (Исполнители) — серверы или машины, которые выполняют задачи из .gitlab-ci.yml. GitLab предлагает свои Shared Runners, а также позволяет настраивать свои, если необходима кастомизация.

### Пример файла .gitlab-ci.yml для автотестов
Вот пример файла .gitlab-ci.yml, который запускает автотесты на Python с использованием Pytest и формирует отчет в формате HTML:
```yaml
stages:
  - test

test-job:
  stage: test
  image: python:3.11
  script:
    - pip install -r requirements.txt
    - pytest --html=report.html
  artifacts:
    paths:
      - report.html
```

### Объяснение файла
- **stages** — описывает этапы, в данном случае только этап test.
- **test-job** — определение задачи, которая принадлежит этапу test.
- **image** — Docker-образ, который используется для выполнения задачи. В данном примере используется образ Python.
- **script** — команды, которые выполняются в рамках задачи.
- **artifacts** — артефакты, такие как HTML-отчет, которые будут сохранены после выполнения задачи.

### Визуализация CI/CD Pipeline
После добавления файла .gitlab-ci.yml при каждом коммите GitLab автоматически создает pipeline, который можно наблюдать на вкладке **CI/CD > Pipelines**. На этой странице будут отображаться все стадии и статус выполнения задач.

### Преимущества использования GitLab CI для тестирования
- **Автоматизация тестов**: Все тесты запускаются автоматически при каждом коммите или Pull Request, что позволяет избежать ручного запуска.
- **Централизация отчетов**: Результаты тестов хранятся в GitLab и доступны всей команде.
- **Легкость настройки**: Достаточно создать и настроить .gitlab-ci.yml файл.
- **Интеграция с Git**: GitLab CI тесно интегрирован с Git, что упрощает управление версиями и отслеживание изменений.

Для более детального изучения можно посетить [официальную документацию GitLab CI](https://docs.gitlab.com/ee/ci/).

[вверх](#102-cicd-системы)


## GitHub Actions

[GitHub Actions](https://github.com/features/actions) — это инструмент для автоматизации рабочих процессов на платформе GitHub. Он позволяет автоматически запускать сборку, тестирование, деплой и другие процессы при обновлении кода. В контексте автоматизации тестирования GitHub Actions удобно использовать для настройки CI/CD, чтобы при каждом коммите или Pull Request (PR) запускались автотесты.

### Как работает GitHub Actions
- **Workflow (Рабочий процесс)** — основной процесс, который описывается в YAML-файле и включает набор задач (jobs), выполняющихся автоматически при определённых событиях, таких как коммит в репозиторий или создание PR.
- **Events (События)** — триггеры, которые запускают workflows, например, push в ветку, создание PR, создание релиза и так далее.
- **Jobs (Задачи)** — отдельные задачи, которые можно выполнять параллельно или последовательно. Обычно каждый job состоит из нескольких шагов (steps).
- **Steps (Шаги)** — это действия, которые последовательно выполняются в рамках одного job. Каждый шаг может включать команду или действие (action).
- **Runners (Исполнители)** — машины (серверы), на которых выполняются задачи. GitHub предоставляет свои Ubuntu, Windows и macOS runners, но можно настроить и собственные runners.

### Пример файла Workflow для Python автотестов
Вот пример файла *.github/workflows/test.yml*, который запускает автотесты на Python с помощью Pytest и формирует отчет в формате HTML:
```yaml
name: Run Python Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest --html=report.html

      - name: Upload Test Report
        uses: actions/upload-artifact@v2
        with:
          name: test-report
          path: report.html
```

### Объяснение файла
- **name** — название workflow, которое будет отображаться в интерфейсе GitHub.
- **on** — событие, которое запускает workflow, в данном случае — push и pull_request в ветку main.
- **jobs** — определение задач:
    - **test** — название задачи.
    - **runs-on** — указывает операционную систему для запуска (в данном примере используется ubuntu-latest).
    - **steps** — шаги внутри задачи:
        - **Checkout code** — загружает код репозитория.
        - **Set up Python** — задаёт нужную версию Python.
        - **Install dependencies** — устанавливает зависимости.
        - **Run tests** — запускает тесты с помощью Pytest.
        - **Upload Test Report** — загружает отчет как артефакт, чтобы его можно было скачать и просмотреть.

### Настройка публикации отчета на GitHub Pages

Чтобы отчеты об автотестах автоматически публиковались на GitHub Pages, можно добавить еще один job для копирования отчета в ветку gh-pages:
```yaml
name: Run Python Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest --html=report.html

      - name: Upload Test Report
        uses: actions/upload-artifact@v2
        with:
          name: test-report
          path: report.html

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          destination_dir: report.html
```

###  Объяснение деплоя на GitHub Pages
- **deploy** — дополнительная задача, которая зависит от выполнения *test*.
- **needs: test** — эта строка указывает, что job *deploy* выполнится только после успешного завершения job *test*.
- **uses: peaceiris/actions-gh-pages@v3** — популярное готовое действие для публикации файлов на GitHub Pages.
- **github_token** — встроенная переменная GitHub, которая позволяет передать доступ для записи.
- **publish_dir** и **destination_dir** — задают, какие файлы публиковать (в данном примере используется *report.html*).

### Преимущества использования GitHub Actions для тестирования
- **Автоматизация тестов** — тесты запускаются автоматически при коммитах или PR.
- **Гибкость** — поддержка различных триггеров и условий выполнения.
- **Простота интеграции** — встроено в GitHub, не требует внешних инструментов.
- **Возможность публикации отчетов** — автоматическая публикация результатов на GitHub Pages для лёгкого доступа.

Подробнее о GitHub Actions можно узнать из [официальной документации](https://docs.github.com/en/actions).

[вверх](#102-cicd-системы)


## Jenkins

[Jenkins](https://www.jenkins.io/) — это одна из самых популярных систем для организации CI/CD процессов. Это open-source инструмент, который позволяет автоматизировать сборку, тестирование, и развертывание приложений. Jenkins поддерживает множество интеграций и плагинов, что делает его универсальным решением для самых разных проектов.

### Особенности Jenkins

1. **Открытость и гибкость**: Jenkins — это бесплатный инструмент с открытым исходным кодом, что позволяет адаптировать его под любые нужды и интегрировать практически с любой системой.
2. **Большая экосистема плагинов**: Jenkins предлагает тысячи плагинов для интеграции с различными языками программирования, фреймворками, системами управления версиями и облачными платформами.
3. **Поддержка различных типов проектов**: Jenkins подходит как для разработки приложений, так и для автоматизации тестирования. Он широко используется в CI/CD процессах для организации запуска автотестов, создания отчётов и развертывания приложений.

### Как работает Jenkins?
Jenkins автоматизирует выполнение различных этапов CI/CD, предоставляя возможность настроить так называемые **pipelines** — последовательности задач, которые будут выполняться в заданном порядке.

1. **Jobs**: Jenkins организует задачи в виде job'ов. Каждый job — это самостоятельный процесс, который может быть нацелен на выполнение определенного шага, например, сборки или тестирования.
2. **Pipelines**: Для более сложных сценариев можно объединить несколько job'ов в pipeline. Pipeline можно создать с помощью графического интерфейса или с использованием Jenkinsfile — файла с описанием шагов на языке Groovy.
3. **Triggers**: Jenkins позволяет настроить триггеры для запуска jobs или pipelines при определенных событиях, таких как обновление кода в репозитории или расписание по времени.

### Как настроить Jenkins Pipeline для автотестов

Для создания CI/CD pipeline в Jenkins, особенно для автоматизации тестирования, нужно выполнить следующие шаги:

1. **Установка Jenkins**: Jenkins можно установить на сервере или использовать уже настроенную инстанцию, если она предоставлена вашей компанией. Установку можно произвести с официального сайта Jenkins.
2. **Создание проекта и Jenkinsfile**: Создайте новый pipeline-проект. Для его настройки потребуется **Jenkinsfile** — файл, который описывает шаги вашего CI/CD процесса. Пример Jenkinsfile для запуска тестов на Python:
```groovy
pipeline {
    agent any

    stages {
        stage('Clone Repository') {
            steps {
                git 'https://github.com/user/repo'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'pip install -r requirements.txt'
            }
        }

        stage('Run Tests') {
            steps {
                sh 'pytest --junitxml=report.xml'
            }
        }

        stage('Generate Report') {
            steps {
                publishHTML([
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'htmlcov',
                    reportFiles: 'index.html',
                    reportName: 'Test Report'
                ])
            }
        }
    }
}
```
3. **Запуск Pipeline**: После настройки можно запустить pipeline вручную или настроить автоматический запуск по расписанию или событию, например, при пуше в репозиторий.

### Примеры использования

- **Запуск автотестов**: Jenkins может автоматически запускать автотесты при каждом обновлении кода, создавая отчёты и отправляя уведомления о результатах.
- **Развертывание на сервере**: После успешного тестирования Jenkins может автоматически развернуть приложение на сервере или в облачной среде.
- **Отправка уведомлений**: Jenkins может отправлять отчеты о результатах тестирования на email или в системы для командного общения, такие как Slack или Microsoft Teams.

### Преимущества и недостатки

- **Преимущества**:
    - Большая гибкость и возможность настройки под любые требования.
    - Поддержка множества плагинов и возможность интеграции с большинством инструментов разработки и тестирования.
    - Подходит для работы как с простыми, так и с большими проектами.
- **Недостатки**:
    - Требуется значительное время на настройку и поддержку.
    - Для работы с Jenkinsfile необходимы знания Groovy и YAML.
    - Интерфейс может быть не таким интуитивным по сравнению с новыми CI/CD платформами.

Jenkins является мощным инструментом для автоматизации CI/CD процессов, и его гибкость делает его одним из лучших решений для проектов любой сложности.

[вверх](#102-cicd-системы)


## CircleCI

[CircleCI](https://circleci.com/) — это облачная платформа CI/CD, которая автоматизирует сборку, тестирование и развертывание приложений. CircleCI позволяет командам легко настроить и масштабировать процессы CI/CD без необходимости управлять собственной инфраструктурой. CircleCI интегрируется с GitHub, GitLab и Bitbucket, что делает его удобным для разработки в командах, использующих распределённые системы контроля версий.

### Особенности CircleCI

1. **Облачная и локальная версии**: CircleCI можно использовать как облачное решение, так и развернуть локально (CircleCI Server). Облачная версия не требует управления сервером, а локальная подходит для компаний с особыми требованиями безопасности.
2. **Автоматическая интеграция с Git**: CircleCI легко интегрируется с системами контроля версий, такими как GitHub и GitLab, и автоматически запускает процессы CI/CD при обновлениях в репозитории.
3. **Поддержка Docker**: CircleCI активно использует Docker-контейнеры для изоляции окружений, что упрощает создание одинаковых рабочих окружений для сборки и тестирования.
4. **Автоматическое масштабирование**: CircleCI позволяет динамически увеличивать количество параллельных сборок в зависимости от потребностей команды.

### Как работает CircleCI?
CircleCI использует **config.yml** для настройки процессов CI/CD. В этом файле описываются шаги (steps) и рабочие процессы (jobs), которые определяют, как и когда будет запускаться сборка, тесты и другие процессы.

1. **Jobs и Steps**: В CircleCI процессы делятся на jobs, а каждый job содержит несколько шагов (steps). Например, job для тестирования может включать шаги установки зависимостей, запуска тестов и публикации отчётов.
2. **Workflows**: С помощью workflows можно управлять последовательностью выполнения нескольких jobs. Это удобно для сложных процессов, таких как параллельное тестирование и сборка.
3. **Кэширование и артефакты**: CircleCI поддерживает кэширование и хранение артефактов, что ускоряет выполнение повторных задач и позволяет сохранять результаты сборок или тестов для дальнейшего использования.

### Пример настройки CircleCI для Python автотестов

Для настройки CircleCI вам потребуется файл *.circleci/config.yml* в корневой директории проекта, где будут описаны этапы и команды для выполнения. Вот пример для запуска автотестов на Python:
```yaml
version: 2.1

jobs:
  test:
    docker:
      - image: circleci/python:3.9
    steps:
      - checkout
      - run:
          name: Установка зависимостей
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install -r requirements.txt
      - run:
          name: Запуск тестов
          command: |
            . venv/bin/activate
            pytest --junitxml=test-results/results.xml
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: pytest_results

workflows:
  version: 2
  test_workflow:
    jobs:
      - test
```
В этом примере:
- **docker**: задаёт Docker-контейнер с Python 3.9, в котором будут выполняться все шаги job'а.
- **checkout**: команда для клонирования репозитория.
- **run**: устанавливает зависимости и запускает тесты.
- **store_test_results** и **store_artifacts**: сохраняют результаты тестов и артефакты для дальнейшего анализа.

### Запуск workflows

Когда в репозиторий пушится код, CircleCI автоматически запускает workflow в соответствии с конфигурацией. Это позволяет настроить автоматический запуск тестов или других процессов при каждом обновлении кода.

### Преимущества и недостатки
- **Преимущества**:
    - CircleCI — облачное решение, что снимает нагрузку по управлению сервером.
    - Поддержка Docker, кэширования и параллельных сборок.
    - Гибкость в настройке workflows и jobs для создания кастомных CI/CD процессов.
- **Недостатки**:
    - Бесплатные функции ограничены, поэтому при больших объёмах использования могут потребоваться платные планы.
    - Для некоторых типов проектов могут возникнуть ограничения производительности в зависимости от выбранных ресурсов.

CircleCI предоставляет удобный и масштабируемый способ организации CI/CD процессов. Интеграция с популярными системами контроля версий и Docker, а также гибкость в настройке workflows делают CircleCI популярным выбором для команд, работающих в облачной среде.

[вверх](#102-cicd-системы)


## TeamCity

[TeamCity](https://www.jetbrains.com/ru-ru/teamcity/) — это CI/CD-платформа от компании JetBrains, которая позволяет автоматизировать сборку, тестирование и развертывание приложений. TeamCity ориентирован на разработчиков, предоставляя широкий функционал для настройки процессов CI/CD, высокую степень кастомизации и поддержку большого числа технологий, включая Docker, Kubernetes, Git, и другие.

### Особенности TeamCity

1. **Поддержка различных технологий и языков**: TeamCity поддерживает множество языков программирования и инструментов (например, Java, .NET, Python, Docker), что делает его универсальным решением для разных типов проектов.
2. **Гибкость и кастомизация**: Благодаря мощным настройкам и удобному интерфейсу, TeamCity позволяет создавать сложные и кастомизированные конвейеры для CI/CD.
3. **Параллельные сборки**: TeamCity позволяет запускать параллельные сборки и распределять задачи между агентами, что ускоряет выполнение CI/CD процессов.
4. **Встроенные плагины**: TeamCity включает множество встроенных плагинов и также поддерживает внешние, что позволяет расширять его функциональность для работы с различными системами, такими как Jira, Slack, GitHub, Docker, и другие.

### TeamCity использует серверно-агентную архитектуру:

- Сервер управляет и отслеживает статус задач CI/CD, предоставляет интерфейс и распределяет задачи.
- Агенты выполняют сборки, тестирование и другие задачи, такие как развертывание. Агенты могут быть локальными или облачными, что позволяет распределять нагрузку.

#### Основные элементы TeamCity:
1. **Build Configuration**: Определяет конкретные настройки для выполнения сборки. Можно настроить разные этапы, включая компиляцию, тестирование и публикацию артефактов.
2. **Build Step**: Шаги, которые выполняются в процессе сборки (например, запуск тестов, сборка артефактов).
3. **Templates**: Позволяют создать шаблоны для конфигураций сборок, что упрощает настройку однотипных процессов для нескольких проектов.
4. **Triggers**: Настройки, которые автоматически запускают сборки, например, при каждом коммите в репозиторий.
5. **Artifacts**: Результаты сборки, которые сохраняются и могут быть использованы в других сборках (например, пакеты или файлы отчётов).

### Пример настройки TeamCity для Python автотестов
Чтобы настроить TeamCity для автоматизации запуска тестов на Python, можно создать Build Configuration с шагами для установки зависимостей и запуска тестов. Например:
1. **Создайте проект и добавьте Build Configuration**.
2. **Добавьте шаги сборки**:
    - **Step 1**: Установите зависимости:
        - Runner Type: Command Line
        - Script: pip install -r requirements.txt
    - **Step 2**: Запустите тесты:
        - Runner Type: Command Line
        - Script: pytest --junitxml=test-results/results.xml
3. **Настройте Triggers** для автоматического запуска сборки при каждом коммите в репозиторий.

### Публикация артефактов и отчётов
Чтобы сохранить результаты тестов, можно добавить шаг для публикации артефактов:
1. В настройках **General Settings** добавьте правило сохранения артефактов:
```
test-results/results.xml => test_results
```
2. Это позволит хранить и просматривать отчёты о тестах и использовать их в других конфигурациях.

### Преимущества и недостатки
- **Преимущества**:
    - TeamCity поддерживает расширенные настройки CI/CD процессов и хорошо интегрируется с различными инструментами.
    - Множество плагинов и шаблонов, которые упрощают настройку и поддержание сборок.
    - Высокая гибкость и поддержка параллельных сборок.
- **Недостатки**:
    - TeamCity может быть сложным для начальной настройки, особенно для небольших команд.
    - Ограничения в бесплатной версии могут потребовать покупки лицензии для масштабирования.

TeamCity отлично подходит для крупных проектов и команд, нуждающихся в мощной и гибкой системе CI/CD. Интеграция с различными технологиями, богатый функционал и возможности кастомизации делают его одним из лидеров среди CI/CD решений.

[вверх](#102-cicd-системы)