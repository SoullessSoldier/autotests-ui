# Практика работы с GitHub Actions
[назад](./readme.md)


Содержание:
- [Требования](#требования)
- [Заметки по выполнению](#заметки-по-выполнению)


## Требования
В этом задании вам нужно самостоятельно разделить текущий workflow на две отдельные джобы. Сейчас в workflow запускается только одна джоба, *run-tests*, которая выполняет автотесты и публикует отчет на GitHub Pages. Ваша задача — разделить ее на две отдельные джобы:
- *run-tests* — должна запускать автотесты.
- *publish-report* — должна публиковать отчет на GitHub Pages.

**Важные условия:**
1. После выполнения автотестов у нас появляется папка с результатами — *allure-results*. Эту папку нужно сохранить как артефакт в джобе *run-tests*, а затем загрузить ее в джобе *publish-report*.

Полезные источники о работе с артефактами:
- [GitHub Actions: Upload Artifact](https://github.com/actions/upload-artifact?tab=readme-ov-file#usage)
- [Документация GitHub: Хранение и передача данных между джобами](https://docs.github.com/ru/actions/writing-workflows/choosing-what-your-workflow-does/storing-and-sharing-data-from-a-workflow)
2. Порядок выполнения джоб: *publish-report* должна запускаться только после успешного выполнения *run-tests*. Для этого настройте зависимость между джобами (используйте директиву *needs*).
3. Сохранение текущей логики: вам не нужно изменять код запуска автотестов, генерации и публикации отчета на GitHub Pages. Достаточно лишь разделить процесс на две джобы и настроить сохранение/загрузку артефактов *allure-results*.

Успешное завершение: обе джобы должны проходить успешно, чтобы workflow завершался без ошибок.

По итогу у вас должно быть две джобы.

### Критерии выполнения задания
- Workflow-файл оформлен чисто и аккуратно
- В GitHub Actions workflow есть джоба *run-tests*, которая отвечает за запуск автотестов
- В GitHub Actions workflow есть джоба *publish-report*- , которая сохраняет историю Allure и публикует отчет на GitHub Pages
- Все джобы в рамках workflow должны успешно выполняться

[вверх](#практика-работы-с-github-actions)


## Заметки по выполнению

### Зачем нужны шаги *Get Allure history* и *Prepare Allure history directory*?

Шаги *Get Allure history* и *Prepare Allure history directory* нужны для сохранения истории отчетов Allure между разными запусками тестов.

**1. Что такое allure-history**  
Allure умеет показывать историю изменений тестов: сколько прошло, сколько упало, как меняется статистика, график "прогресса" или "регресса". Для этого он сохраняет в отчете (*allure-report*) специальные JSON-файлы, отражающие историю выполнения тестов.

Чтобы история была непрерывной, Allure при генерации нового отчета должен "знать", как выглядели предыдущие отчеты. Поэтому ему нужно содержимое папки *.allure-history* (обычно она находится в *gh-pages*).

**2. Зачем скачивать gh-pages?**  
Поскольку GitHub Pages использует ветку *gh-pages*, а история хранится в этой ветке, то чтобы получить предыдущую историю, мы:
- Скачиваем ветку *gh-pages* (в папку *gh-pages*).
- Копируем её содержимое в *allure-history*, чтобы Allure смог использовать его при генерации нового отчета.

**3. Зачем это делать во второй джобе?**  
Потому что:
- Первая джоба (*run-tests*) только запускает тесты и сохраняет *allure-results*. У неё нет доступа к *gh-pages*, и она не должна туда лезть.
- Вторая джоба (*publish-report*) — единственная, которая знает, что тесты завершены, и которая публикует результаты. Она и должна объединить новые *allure-results* с предыдущей историей, чтобы получить полный и информативный отчет.

Эти шаги нужны, чтобы новый отчет Allure содержал историю выполнения тестов из прошлых запусков, и пользователь мог видеть динамику: например, сколько тестов упало/прошло в сравнении с прошлым запуском.

Если их убрать, то каждый отчет будет "с нуля", без истории — и вы потеряете ценный функционал Allure.

### Зачем запускать publish-report, если run-tests упала?

Есть несколько причин:

1. Показать отчет даже при падении тестов
Если тесты упали, пользователь всё равно хочет увидеть отчет — с деталями, что именно не прошло. Это помогает быстрее разобраться в причинах.

2. Не терять историю выполнения
Даже если тесты упали, *allure-results* всё равно генерируются (частично или полностью). Их можно использовать, чтобы обновить *allure-history* и сохранить статистику выполнения.

3. Диагностика и аудит
Если *publish-report* не запустится при падении *run-tests*, то отчет о падении не будет опубликован, и разработчики не смогут его посмотреть — это уменьшает прозрачность процесса.

В нашем случае есть требование "Порядок выполнения джоб: *publish-report* должна запускаться только после успешного выполнения *run-tests*.", т.е. если вы не хотите публиковать отчет, когда тесты упали, то можно убрать if: always() у джобы *publish-report*.

[вверх](#практика-работы-с-github-actions)