# 10.4 Запуск автотестов на CI
[назад](../readme.md)


Содержание
- [Подготовка к запуску автотестов на CI: GitHub Actions](#подготовка-к-запуску-автотестов-на-ci-github-actions)
- [Первый запуск автотестов на CI: GitHub Actions](#первый-запуск-автотестов-на-ci-github-actions)
- [Практика работы с GitHub Actions](#практика-работы-с-github-actions)

## Подготовка к запуску автотестов на CI: GitHub Actions

Ссылки:
- [GitHub Actions Marketplace](https://github.com/marketplace?type=actions)
- [GitHub Action для установки python](https://github.com/actions/setup-python)
- [GitHub Action для извлечения кода репозитория](https://github.com/actions/checkout)
- [GitHub Action для загрузки артефактов](https://github.com/actions/upload-artifact)
- [GitHub Action для скачивания артефактов](https://github.com/actions/download-artifact)
- [GitHub Actioin для генерации Allure отчета с сохранением истории](https://github.com/simple-elf/allure-report-action)
- [GitHubActions для публикации на GitHub Pages](https://github.com/peaceiris/actions-gh-pages)

В этом уроке мы разберем, как запустить автотесты на CI, используя GitHub Actions.

Важно! В этом уроке мы будем работать с различными GitHub Actions, необходимыми для автоматизации процессов в CI/CD. Версии используемых Actions регулярно обновляются, поэтому крайне важно проверять актуальные версии в официальных репозиториях перед их использованием.

### 1. Создаем файл workflow: .github/workflows/tests.yml

Для начала нужно создать файл .github/workflows/tests.yml, в котором будут описаны все инструкции для запуска автотестов.
```
.
└── .github/
    └── workflows/
        └── tests.yml
```

### 2. Описываем шаги workflow

Откроем файл *.github/workflows/tests.yml* и добавим в него инструкции, которые позволят GitHub Actions понять, как запускать наши автотесты.

### Теперь давайте подробно разберем, что происходит в данном файле

#### 1. Имя Workflow
```yaml
name: UI tests
```
**Что происходит:**  
Этот параметр указывает имя для workflow в GitHub Actions. В данном случае, оно называется "UI tests", и это имя будет отображаться в интерфейсе GitHub Actions, чтобы легко было найти и понять, что этот workflow связан с тестированием интерфейса.

#### 2. Триггеры для запуска Workflow
```yaml
on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
```
**Что происходит:**  
Здесь задаются триггеры, которые запускают данный workflow:
- **push**: Workflow будет запускаться каждый раз, когда кто-то сделает коммит в ветку main вашего репозитория.
- **pull_request**: Workflow будет также запускаться, когда кто-то создаст pull request, нацеленный на ветку main.

Этот параметр позволяет настроить автоматический запуск тестов каждый раз, когда происходят изменения в главной ветке репозитория.

##### 3. Объявление Jobs
```yaml
jobs:
  run-tests:
    runs-on: ubuntu-latest
```
**Что происходит:**  
Здесь начинается определение **jobs** (работ), которые будут выполнены в рамках workflow. В данном случае мы создаём одну задачу — *test*.
    - **runs-on: ubuntu-latest** — Указывает, что задача будет выполняться на виртуальной машине с последней версией Ubuntu, предоставленной GitHub Actions. Это значит, что все шаги в этой задаче будут запускаться в среде Ubuntu, что гарантирует одинаковые условия для выполнения тестов.

#### 4. Шаг 1: Клонирование репозитория
```yaml
- name: Check out repository
  uses: actions/checkout@v4  # Используем GitHub Action для клонирования репозитория
```
**Что происходит:**  
На первом шаге используется стандартный GitHub Action *actions/checkout@v4*, который клонирует репозиторий на виртуальную машину, где будет выполняться тестирование. Это необходимо для того, чтобы GitHub Actions имел доступ к вашему коду и файлам проекта.

#### 5. Шаг 2: Настройка Python
```yaml
- name: Set up Python
  uses: actions/setup-python@v4  # Используем GitHub Action для установки Python
  with:
    python-version: '3.11'  # Устанавливаем версию Python 3.11
```
**Что происходит:**  
Этот шаг устанавливает Python на виртуальной машине:
- Мы используем GitHub Action *actions/setup-python@v4* для установки Python.
- Указываем, что хотим установить Python **версии 3.11**. Это означает, что на виртуальной машине будет работать именно эта версия Python, а не какая-либо другая.

Этот шаг важен для того, чтобы окружение для тестов было настроено правильно и совместимо с вашими зависимостями (если они требуют определённой версии Python).

#### 6. Шаг 3: Установка зависимостей
```yaml
- name: Install dependencies
  run: |
    python -m pip install --upgrade pip  # Обновляем pip до последней версии
    pip install -r requirements.txt  # Устанавливаем зависимости из requirements.txt
    playwright install --with-deps  # Устанавливаем браузеры для Playwright
```
**Что происходит:**  
Здесь выполняются следующие действия:
- Сначала обновляется **pip** (менеджер пакетов Python) до последней версии.
- Затем с помощью команды *pip install -r requirements.txt* устанавливаются все зависимости, которые указаны в файле *requirements.txt* вашего проекта. Этот файл обычно содержит все библиотеки, которые нужны для работы с вашим проектом, в том числе для запуска тестов.
- После этого с помощью команды *playwright install* устанавливаются браузеры, необходимые для работы с **Playwright** — инструментом для автоматизации UI-тестов.

#### 7. Шаг 4: Запуск тестов с pytest и генерация отчётов Allure
```yaml
- name: Run Playwright tests with pytest and generate Allure results
  run: |
    pytest -m regression --alluredir=allure-results --numprocesses 2  # Запускаем тесты и генерируем результаты для Allure
```
**Что происходит:**  
Этот шаг запускает **pytest** — фреймворк для тестирования Python. Он будет искать тесты, помеченные маркером *regression* и запускать их. Результаты тестов будут сохраняться в папку *allure-results* в формате, совместимом с Allure.

Параметр *--numprocesses 2* означает, что тесты будут выполняться параллельно в два потока, что ускоряет выполнение тестов.

#### 8. Шаг 5: Получение истории Allure отчётов
```yaml
- name: Get Allure history
  uses: actions/checkout@v4  # Опять клонируем репозиторий для получения истории отчётов
  if: always()  # Всегда выполняем этот шаг
  continue-on-error: true  # Если будет ошибка, продолжим выполнение
  with:
    ref: gh-pages  # Указываем ветку gh-pages для получения истории
    path: gh-pages  # Указываем путь, куда сохранить данные
```
**Что происходит:**  
На этом шаге мы снова клонируем репозиторий, но на этот раз из ветки *gh-pages* — ветки, где будет храниться история отчётов Allure. Эти отчёты необходимы для сравнения новых результатов с предыдущими.
- **if: always()** гарантирует, что этот шаг выполнится всегда, независимо от того, были ли успешными предыдущие шаги.
- **continue-on-error: true** означает, что даже если этот шаг завершится с ошибкой, workflow продолжит выполняться.

#### 9. Шаг 6: Генерация отчёта Allure
```yaml
- name: Generates Allure Report with history
  uses: simple-elf/allure-report-action@v1.7  # Используем готовое решение для генерации Allure отчёта
  if: always()  # Выполняем всегда
  with:
    allure_results: allure-results  # Указываем каталог с результатами тестов
    allure_history: allure-history  # Указываем каталог для истории отчётов
```
**Что происходит:**  
Здесь используется готовое решение для генерации отчёта Allure. Это действие из GitHub Marketplace автоматически создает визуальный отчёт о выполнении тестов, который можно просматривать в браузере.
- **allure_results** — указывает на папку, где хранятся результаты тестов.
- **allure_history** — указывает на папку для истории предыдущих отчётов, чтобы можно было сравнивать новые и старые результаты тестов.

#### 10. Шаг 7: Деплой отчёта на GitHub Pages
```yaml
- name: Deploy report to Github Pages
  if: always()  # Выполняем всегда
  uses: peaceiris/actions-gh-pages@v4  # Используем GitHub Action для публикации отчёта на GitHub Pages
  with:
    github_token: ${{ secrets.GITHUB_TOKEN }}  # Токен для аутентификации на GitHub
    publish_branch: gh-pages  # Указываем, что отчёт будет опубликован в ветке gh-pages
    publish_dir: allure-history  # Указываем папку, которая будет опубликована на GitHub Pages
```
**Что происходит:** 
Этот шаг публикует отчёт, сгенерированный на предыдущем шаге, на **GitHub Pages**. GitHub Pages — это сервис для хостинга веб-страниц прямо из репозитория.
- **github_token** — секретный токен, который используется для аутентификации на GitHub и позволяет выполнять операции с репозиторием.
- **publish_branch** — указывает ветку *gh-pages*, куда будет отправлен отчёт.
- **publish_dir** — указывает на папку с результатами (*allure-history*), которая будет опубликована.

В результате, отчёт будет доступен по URL, связанному с репозиторием, и его можно будет просматривать в браузере. Пока URL для просмотра не доступен, потому что мы еще не опубликовали изменения на GitHub, но это сделаем в следующем шаге

[вверх](#104-запуск-автотестов-на-ci)


## Первый запуск автотестов на CI: GitHub Actions

Теперь, когда мы создали файл с workflow, можем запустить автотесты на GitHub Actions. Однако перед этим важно выполнить некоторые настройки, чтобы избежать проблем в будущем.

### 1. Включение доступа на запись для запуска workflow

Для публикации файлов в ветку GitHub Pages workflow использует токен аутентификации, генерируемый GitHub. По умолчанию этот токен не имеет прав на запись, и в логах запуска workflow может появиться ошибка.  
Чтобы устранить эту ошибку, нужно предоставить токену права на запись:
- Перейдите на страницу проекта на GitHub и откройте раздел **Settings → Actions → General**.
- В секции **Workflow permissions** выберите **Read and write permissions**.
- Нажмите **Save**.

### 2. Создание ветки gh-pages

Чтобы корректно опубликовать **Allure** отчет на **GitHub Pages** необходимо в репозитории *autotests-ui* создать ветку *gh-pages*

### 3. Запуск автотестов

Теперь давайте зафиксируем изменения и отправим их в удаленный репозиторий.  
После отправки коммита в репозиторий, на главной странице репозитория отобразится статус запуска workflow.  
Нажав на значок статуса, можно открыть окно с текущим запуском и перейти к его деталям.  
Для просмотра всех запусков перейдите на вкладку Actions.  
Во вкладке Actions вы увидите список всех запусков workflow для текущего проекта, с информацией о статусе, ветке, времени запуска и коммите, из которого был запущен workflow.  

[вверх](#104-запуск-автотестов-на-ci)


### Настраиваем GitHub Pages

В предыдущем шаге мы запустили автотесты на CI через GitHub Actions. В нашем workflow есть шаг для публикации Allure-отчета на GitHub Pages.  
После успешного запуска CI в репозитории autotests-ui автоматически создается ветка *gh-pages*. Именно из этой ветки GitHub Pages будет публиковать Allure-отчеты.  
Если переключиться на ветку *gh-pages*, там будут папки с Allure-отчетами для каждого запуска, где название папки — это идентификатор запуска.

#### Включаем публикацию на GitHub Pages
После первого запуска workflow на GitHub Actions отчёт будет отправлен в ветку gh-pages, но для его публикации на GitHub Pages нужно выполнить несколько настроек.
- Перейдите в **Settings → Pages**.
- В разделе **Build and deployment** выберите:
    - **Source**: “Deploy from a branch”.
    - **Branch**: *gh-pages*, а в следующем поле выберите “/ (root)”.
- Нажмите **Save**.
На вкладке **Actions** убедитесь, что был автоматически создан запуск workflow **pages build and deployment**. Подождите его завершения.  

Благодаря шагам *Get Allure history* и *Allure Report action* в отчете будет сохраняться история выполнений, что позволяет отслеживать изменения в результатах тестов со временем.

В отчете теперь отображается блок **Executors** с информацией о CI, на котором запускались тесты, а также ссылка на соответствующий запуск в GitHub Actions.

Во вкладке **History** каждого теста можно увидеть его историю запусков, что позволяет анализировать стабильность и изменения в работе теста.

На этом настройка завершена! Теперь автотесты будут запускаться на CI, а Allure-отчет будет автоматически публиковаться на GitHub Pages для удобного просмотра и анализа.

[вверх](#104-запуск-автотестов-на-ci)


## Практика работы с GitHub Actions

[ссылка на описание домашней работы](./homework.md)

[вверх](#104-запуск-автотестов-на-ci)
