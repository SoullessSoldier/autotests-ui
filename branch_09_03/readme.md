# 9.3 Параллельный запуск автотестов
[назад](../readme.md)


Содержание:
- [Знакомимся с параллелизмом](#знакомимся-с-параллелизмом)
- [Запускаем автотесты параллельно](#запускаем-автотесты-параллельно)
- [Работаем с xdist group](#работаем-с-xdist-group)

## Знакомимся с параллелизмом

На текущий момент все наши автотесты запускаются синхронно. Это означает, что Playwright открывает браузер, выполняет определенные действия, затем закрывает браузер и переходит к следующему, выполняя все действия последовательно. Такой подход может значительно увеличить общее время выполнения тестов, особенно когда их много.

### Что такое параллельный запуск автотестов?
Параллелизм — это знакомое многим понятие, но давайте рассмотрим его в контексте запуска автотестов. Параллельный запуск означает, что мы можем одновременно запустить несколько браузеров, и каждый из них будет выполнять действия теста независимо от других. Таким образом, если мы запускаем два браузера одновременно, мы можем выполнять два автотеста в одно и то же время. Это может дать нам удвоение скорости выполнения тестов, однако следует учитывать некоторые нюансы.

Каждый экземпляр браузера требует одного ядра процессора (или одного CPU). Это значит, что бесконечное количество браузеров запустить невозможно. Например, если на вашей машине всего 4 процессорных ядра, вы сможете одновременно запустить только 4 браузера. Это число будет меньше, если на вашем компьютере работают другие программы, потребляющие ресурсы. В официальной документации Playwright рекомендуется использовать половину доступных логических ядер: "We recommend half of logical CPU cores. Depending on the hardware and nature of your tests, you can set numprocesses to be anywhere from 2 to the number of CPUs on the machine. If set too high, you may notice unexpected behavior." То есть, если у вас на компьютере 4 ядра, для автотестов рекомендуется использовать 2, чтобы достичь максимальной эффективности и избежать перегрузки системы.

### Зачем нужен параллельный запуск?
На данный момент у нас есть около 10 UI автотестов, которые выполняются за 1-2 минуты. Это достаточно быстро, но представьте, что количество автотестов увеличивается до 200. Если запускать их синхронно, на это уйдет примерно 30 минут — довольно много, особенно учитывая, что в реальных проектах количество автотестов может достигать 500, 1000 или даже 1500.

Таким образом, параллельный запуск становится единственным эффективным вариантом ускорения выполнения тестов. Запуск автотестов в несколько потоков позволяет значительно сократить общее время их выполнения, что особенно важно в условиях непрерывной интеграции и доставки (CI/CD).

### Примечания о параллелизме
1. **Управление зависимостями**: Параллельный запуск требует внимательного управления зависимостями между тестами. Если тесты зависят друг от друга (например, данные, созданные в одном тесте, могут быть нужны в другом), это может привести к нестабильности.
2. **Ресурсоемкость**: Следует также учитывать, что параллельный запуск увеличивает нагрузку на систему. Тесты могут потреблять много памяти и процессорных ресурсов, особенно если используются тяжелые страницы или сложные взаимодействия с UI.
3. **Инструменты и библиотеки**: Использование инструмента для управления параллелизмом, такого как pytest-xdist, может значительно упростить процесс распределения тестов между несколькими потоками или процессами.
4. **Отладка и мониторинг**: Параллельный запуск может усложнить отладку тестов. Важно иметь хорошие механизмы логирования и мониторинга, чтобы быстро находить и исправлять ошибки.

Параллелизм — это мощный инструмент, который может значительно повысить производительность ваших автотестов, но его следует использовать с осторожностью и вниманием к деталям.

[вверх](#93-параллельный-запуск-автотестов)


## Запускаем автотесты параллельно

Ссылки:
- [Официальная документация pytest-xdist](https://pytest-xdist.readthedocs.io/en/stable/)
- [Официальная документация Playwright по параллельному запуску](https://playwright.dev/python/docs/test-runners#parallelism-running-multiple-tests-at-once)

### Установка pytest-xdist
Использование плагина pytest-xdist максимально простое. Давайте установим библиотеку pytest-xdist. Для этого в корне проекта autotests-ui выполните следующую команду:
```sh
pip install pytest-xdist
```

### Запуск автотестов параллельно

Теперь мы готовы запустить автотесты параллельно. Для этого нужно добавить флаг *--numprocesses* или *--n*. Например:

- *--numprocesses=5* запустит автотесты параллельно на 5 ядрах процессора.
- *--numprocesses=auto* автоматически использует все доступные ядра вашего компьютера для запуска автотестов.
Теперь выполните следующую команду для параллельного запуска:
```sh
python -m pytest -m "regression" --numprocesses=2
```

Вспомним рекомендацию из документации Playwright: "**We recommend half of logical CPU cores**."

Можно сделать вывод, что запуск на максимальном количестве ядер процессора не всегда означает максимальную скорость выполнения автотестов; самым оптимальным вариантом оказался запуск на половине доступных ядер.

[вверх](#93-параллельный-запуск-автотестов)


## Работаем с xdist group

Существуют ситуации, когда запуск автотестов параллельно недопустим. Рассмотрим это на примере. У нас есть два автотеста: *test_successful_registration* и *test_wrong_email_or_password_authorization*. Один автотест проверяет успешную регистрацию пользователя, а другой — что незарегистрированный пользователь не может войти в систему. При этом оба теста используют одинаковые пользовательские данные для входа и регистрации. Если эти автотесты будут запускаться параллельно, возможно возникновение ситуации, когда один тест зарегистрирует пользователя, а второй попытается войти с этими же данными, ожидая, что пользователь отсутствует в системе. Это приведет к ошибкам и ложным отрицательным результатам.

**Важно**! На самом деле, в нашем случае автотесты работают корректно, поскольку тестируемое приложение UI Course https://nikita-filonov.github.io/qa-automation-engineer-ui-course/#/auth/login не имеет серверной части. Поэтому использование одних и тех же данных не вредит тестам, и при параллельном запуске проблем также не будет. Однако в реальном мире, где приложения имеют серверную часть, проблемы с данными при параллельном запуске следует решать на уровне различных входных данных, то есть использовать разные данные пользователей.

### Решение проблемы с помощью pytest-xdist group
Для решения данной проблемы необходимо, чтобы автотесты *test_successful_registration* и *test_wrong_email_or_password_authorization* запускались синхронно. Это будет означать, что хотя тесты и будут запускаться параллельно, конкретно эти два автотеста будут выполняться в рамках одного потока синхронно, что исключит возможность гонки данных. Для этого нужно добавить к тестам маркировку *@pytest.mark.xdist_group(name="authorization-group")*, чтобы *pytest-xdist* знал, что эти автотесты должны запускаться в одном потоке.

#### Доработка автотеста test_wrong_email_or_password_authorization:
```python
    # Остальной код без изменений

    
    @pytest.mark.xdist_group(name="authorization-group")  # Добавили xdist группу
    @pytest.mark.parametrize( 
        "email, password",
        [
            ("user.name@gmail.com", "password"),
            ("user.name@gmail.com", "  "),
            ("  ", "password")
        ]
    )
    @allure.tag(AllureTag.USER_LOGIN)
    @allure.title("User login with wrong email or password")
    @allure.severity(Severity.CRITICAL)
    def test_wrong_email_or_password_authorization(self, login_page: LoginPage, email: str, password: str):
        # Остальной код без изменений
```

Доработка автотеста *test_successful_registration*:
```python
    # Остальной код без изменений
    

    @pytest.mark.xdist_group(name="authorization-group")  # Добавили xdist группу
    @allure.title("Registration with correct email, username and password")
    @allure.severity(Severity.CRITICAL)
    def test_successful_registration(self, dashboard_page: DashboardPage, registration_page: RegistrationPage):
        # Остальной код без изменений
```

Название группы может быть произвольным, например *authorization-group*, главное, чтобы оно отражало признак, по которому группируются автотесты. Теперь, если мы запустим автотесты, то *test_successful_registration* и *test_wrong_email_or_password_authorization* будут выполняться последовательно:
```sh
python -m pytest -m "regression" --numprocesses=5 --dist=loadgroup
```
- *--numprocesses=*5 → количество воркеров.
- *--dist=loadgroup* → включает режим, который **учитывает маркер *xdist_group* ** и гарантирует, что тесты одной группы не будут разбросаны по разным воркерам.

Важно подчеркнуть, что проблемы с параллельным запуском в идеале должны решаться на уровне самих автотестов. Например, это может быть сделано через использование различных пользователей, параметризацию тестов или изоляцию тестов друг от друга. Если у вас возникает специфическая ситуация, которую невозможно решить на уровне автотестов, то можно прибегнуть к использованию *@pytest.mark.xdist_group*. В моей практике еще не встречались автотесты, которые требовали бы запуска через *@pytest.mark.xdist_group*, и проблему невозможно было бы решить на уровне самих тестов.

[вверх](#93-параллельный-запуск-автотестов)